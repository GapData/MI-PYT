#!/usr/bin/env python3
import os
import sys

import requests
from lxml import etree


BASE = 'https://edux.fit.cvut.cz/courses/MI-PYT'

login_url = '{}/start?do=login'.format(BASE)
session = requests.Session()

r = session.get(login_url)
tree = etree.HTML(r.text)
sectok = None
for inp in tree.findall('.//input'):
    if inp.attrib.get('name') == 'sectok':
        sectok = inp.attrib.get('value', '')
        break
if sectok is None:
    raise ValueError('Could not find sectok on login page')

login_data = {
    'sectok': sectok,
    'id': 'start',
    'do': 'login',
    'authnProvider': '2',
    'u': os.environ.get('EDUX_USER'),
    'p': os.environ.get('EDUX_PASSWORD'),
    'r': '1',
}

r = session.post(login_url, params={'sectok': sectok}, data=login_data)
if 'Přihlášen(a) jako' not in r.text:
    raise ValueError('Could not login')


with open(sys.argv[1], 'r') as f:
    content = f.read()

url = sys.argv[1][len('.dokuwiki'):-len('.txt')]
url = '{}{}?do=edit'.format(BASE, url)
r = session.get(url)

tree = etree.HTML(r.text)
edit_form = None
for form in tree.findall('.//form'):
    if form.attrib.get('id') == 'dw__editform':
        edit_form = form
        break
if edit_form is None:
    raise ValueError('Could not find edit form on parsed page')

data = {}
for inp in form.findall('.//input'):
    name = inp.attrib.get('name')
    if name == 'do[save]' or not name.startswith('do['):
        data[name] = inp.attrib.get('value', '')

data['wikitext'] = content

r = session.post(url, data=data)
# Edux does not provide bad exit statuses, so just hope for the best

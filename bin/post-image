#!/usr/bin/env python3
import os
import sys

import requests
from lxml import etree


BASE = 'https://edux.fit.cvut.cz/courses/MI-PYT'
URL = '{}/lib/exe/mediamanager.php'.format(BASE)
path = sys.argv[1]
filename = os.path.basename(path)
session = requests.Session()


login_url = '{}/start?do=login'.format(BASE)
session = requests.Session()

r = session.get(login_url)
tree = etree.HTML(r.text)
sectok = None
for inp in tree.findall('.//input'):
    if inp.attrib.get('name') == 'sectok':
        sectok = inp.attrib.get('value', '')
        break
if sectok is None:
    raise ValueError('Could not find sectok on login page')

login_data = {
    'sectok': sectok,
    'id': 'start',
    'do': 'login',
    'authnProvider': '2',
    'u': os.environ.get('EDUX_USER'),
    'p': os.environ.get('EDUX_PASSWORD'),
    'r': '1',
}

r = session.post(login_url, params={'sectok': sectok}, data=login_data)
if 'Přihlášen(a) jako' not in r.text:
    raise ValueError('Could not login')

r = session.get(URL)


tree = etree.HTML(r.text)
sectok = None
for inp in tree.findall('.//input'):
    if inp.attrib.get('name') == 'sectok':
        sectok = inp.attrib.get('value')
        break
if sectok is None:
    raise ValueError('Could not find sectok on parsed page')


data = {
    'sectok': sectok,
    'ns': 'tutorials',
    'id': filename,
    'ow': 1,
}

with open(path, 'rb') as f:
    files = {'upload': (filename, f)}
    r = session.post(URL, files=files, data=data)

ret = 0
tree = etree.HTML(r.text)
for div in tree.findall('.//div'):
    if div.attrib.get('class') == 'error':
        ret = 1
        print(div.text, file=sys.stderr)

sys.exit(ret)
